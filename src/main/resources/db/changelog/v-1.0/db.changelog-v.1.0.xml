<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

        <changeSet author="denis" id="01">
            <createTable tableName="genre">
                <column autoIncrement="true" name="id" type="BIGINT">
                    <constraints primaryKey="true"/>
                </column>
                <column name="name" type="VARCHAR(100)"/>
                <column defaultValueComputed="CURRENT_TIMESTAMP" name="created" type="TIMESTAMP(19)">
                    <constraints nullable="false"/>
                </column>
                <column name="updated" type="TIMESTAMP(19)"/>
            </createTable>
        </changeSet>
        <changeSet author="denis" id="10">
            <createTable tableName="movie">
                <column autoIncrement="true" name="id" type="BIGINT">
                    <constraints primaryKey="true"/>
                </column>
                <column name="title" type="VARCHAR(255)">
                    <constraints nullable="false"/>
                </column>
                <column name="poster" type="VARCHAR(1000)"/>
                <column name="premier_date" type="TIMESTAMP(19)"/>
                <column name="imdb" type="DOUBLE"/>
                <column name="description" type="VARCHAR(1000)"/>
                <column defaultValueNumeric="0" name="is_adult" type="BIT(1)">
                    <constraints nullable="false"/>
                </column>
                <column defaultValueComputed="CURRENT_TIMESTAMP" name="created" type="TIMESTAMP(19)">
                    <constraints nullable="false"/>
                </column>
                <column name="updated" type="TIMESTAMP(19)"/>
            </createTable>
        </changeSet>
        <changeSet author="denis" id="20">
            <createTable tableName="movie_genre">
                <column name="movie_id" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
                <column name="genre_id" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
            </createTable>
        </changeSet>
        <changeSet author="denis" id="30">
            <createTable tableName="profile">
                <column autoIncrement="true" name="id" type="BIGINT">
                    <constraints primaryKey="true"/>
                </column>
                <column name="avatar" type="VARCHAR(1000)"/>
                <column name="about" type="VARCHAR(500)"/>
                <column name="email" type="VARCHAR(100)"/>
                <column name="first_name" type="VARCHAR(50)"/>
                <column name="last_name" type="VARCHAR(50)"/>
                <column name="age" type="INT">
                    <constraints nullable="false"/>
                </column>
                <column name="gender" type="VARCHAR(10)">
                    <constraints nullable="false"/>
                </column>
                <column name="region" type="VARCHAR(2)"/>
                <column name="language" type="VARCHAR(2)"/>
                <column defaultValueComputed="CURRENT_TIMESTAMP" name="created" type="TIMESTAMP(19)">
                    <constraints nullable="false"/>
                </column>
                <column name="updated" type="TIMESTAMP(19)"/>
            </createTable>
        </changeSet>
        <changeSet author="denis" id="40">
            <createTable tableName="user">
                <column autoIncrement="true" name="id" type="BIGINT">
                    <constraints primaryKey="true"/>
                </column>
                <column name="username" type="VARCHAR(255)">
                    <constraints nullable="false"/>
                </column>
                <column name="password" type="VARCHAR(255)">
                    <constraints nullable="false"/>
                </column>
                <column name="role" type="VARCHAR(10)">
                    <constraints nullable="false"/>
                </column>
                <column defaultValueNumeric="1" name="active" type="BIT(1)">
                    <constraints nullable="false"/>
                </column>
                <column name="profile_id" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
                <column name="updated" type="TIMESTAMP(19)"/>
                <column defaultValueComputed="CURRENT_TIMESTAMP" name="created" type="TIMESTAMP(19)">
                    <constraints nullable="false"/>
                </column>
            </createTable>
        </changeSet>
        <changeSet author="denis" id="50">
            <createTable tableName="user_movie">
                <column autoIncrement="true" name="id" type="BIGINT">
                    <constraints primaryKey="true"/>
                </column>
                <column name="profile_id" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
                <column name="movie_id" type="BIGINT">
                    <constraints nullable="false"/>
                </column>
                <column name="rating" type="INT"/>
                <column name="notes" type="VARCHAR(128)"/>
                <column defaultValueNumeric="0" name="viewed" type="BIT(1)">
                    <constraints nullable="false"/>
                </column>
                <column defaultValueComputed="CURRENT_TIMESTAMP" name="created" type="TIMESTAMP(19)">
                    <constraints nullable="false"/>
                </column>
                <column name="updated" type="TIMESTAMP(19)"/>
            </createTable>
        </changeSet>
        <changeSet author="denis" id="60">
            <addPrimaryKey columnNames="genre_id, movie_id" constraintName="PRIMARY" tableName="movie_genre"/>
        </changeSet>
        <changeSet author="denis" id="70">
            <createIndex indexName="movie_genre_id_index" tableName="movie_genre">
                <column name="genre_id"/>
            </createIndex>
        </changeSet>
        <changeSet author="denis" id="80">
            <createIndex indexName="user_movie_movie_id_fk" tableName="user_movie">
                <column name="movie_id"/>
            </createIndex>
        </changeSet>
        <changeSet author="denis" id="90">
            <createIndex indexName="user_movie_profile_id_fk" tableName="user_movie">
                <column name="profile_id"/>
            </createIndex>
        </changeSet>
        <changeSet author="denis" id="100">
            <createIndex indexName="user_profile_fk" tableName="user">
                <column name="profile_id"/>
            </createIndex>
        </changeSet>
        <changeSet author="denis" id="110">
            <addForeignKeyConstraint baseColumnNames="movie_id" baseTableName="user_movie" constraintName="user_movie_movie_id_fk" deferrable="false" initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="id" referencedTableName="movie"/>
        </changeSet>
        <changeSet author="denis" id="120">
            <addForeignKeyConstraint baseColumnNames="profile_id" baseTableName="user_movie" constraintName="user_movie_profile_id_fk" deferrable="false" initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="id" referencedTableName="profile"/>
        </changeSet>
        <changeSet author="denis" id="130">
            <addForeignKeyConstraint baseColumnNames="profile_id" baseTableName="user" constraintName="user_profile_fk" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="profile"/>
        </changeSet>
        <changeSet author="denis" id="140">
            <rollback>
                <dropTable tableName="genre"/>
            </rollback>
            <rollback>
                <dropTable tableName="movie"/>
            </rollback>
            <rollback>
                <dropTable tableName="movie_genre"/>
            </rollback>
            <rollback>
                <dropTable tableName="profile"/>
            </rollback>
            <rollback>
                <dropTable tableName="user"/>
            </rollback>
            <rollback>
                <dropTable tableName="user_movie"/>
            </rollback>
        </changeSet>
</databaseChangeLog>